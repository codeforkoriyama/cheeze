/*******************************************************************************
 * Entry Data
 *
 * Copyright (c) 2015. Code for KORIYAMA. All Rights Reserved.
 *
 * @author: Nobuyuki Kondo
 * @uri: http://koriyama.io/
 * @version: 1.0
 ******************************************************************************/
///<reference path="../../dts/libs/jquery.d.ts" />
///<reference path="../../dts/libs/custom.d.ts" />
///<reference path="../assets/Cmn.ts"/>
///<reference path="../../dts/libs/mustache.d.ts"/>
///<reference path="../assets/Events.ts"/>
var EntryData = (function () {
    function EntryData() {
        this.team = [];
        this.filtering = '';
        this.offset = 0;
        this.listTemplate = Cmn.dir + '/mus/filterResult.mustache';
        this.filterTemplate = Cmn.dir + '/mus/filterTeam.mustache';
        this.target = {
            select: '#teamFilter',
            result: '#landscape-result'
        };
        this.flg = {
            start: false
        };
        var _t = this;
        // 初期データの取得
        _t.getEntryData();
        // データの更新(10秒ごと)
        setInterval(function () {
            if (_t.flg.start === false)
                return false;
            _t.flg.start = false;
            _t.getEntryData();
        }, 10000); // 1000ms * 10s = 10000
        // 日付の更新(30秒毎)
        setInterval(function () {
            if (_t.elem === void 0 || _t.flg.start === false)
                return false;
            for (var i = 0, iLen = _t.elem.length; i < iLen; i++) {
                var obj = $(_t.elem[i]), create = obj.data('created'), time = _t.getTimeDiff(create);
                obj.find('.filterResult-date').text(time);
            }
        }, 30000); // 1000ms * 30s = 30000
        // チームフィルタリング
        $(document).on('change', _t.target.select, function () {
            _t.elem.removeClass('hidden');
            var selected = $(this).val();
            if (selected === '0') {
                _t.filtering = '';
            }
            else {
                _t.filtering = selected;
                _t.elem.filter(function (index) {
                    var self = $(this), team = self.data('team');
                    if (team !== selected)
                        self.addClass('hidden');
                });
            }
        });
        // 削除データが有る場合はremove(10分毎)
        setInterval(function () {
            $.ajax({
                url: Cmn.dir + '/deleteData',
                dataType: 'json',
                type: 'GET',
                success: function (data) {
                    if (data.status === 'success') {
                        _t.elem.filter(function (index) {
                            var self = $(this), data_id = String(self.data('id')), isRemove = data.list.indexOf(data_id);
                            if (isRemove > -1) {
                                // 削除データが存在する場合
                                self.remove();
                                _t.elem.splice(index, 1);
                            }
                        });
                    }
                },
                error: function () {
                },
                complete: function () {
                }
            });
        }, 600000); // 1000ms * 60s * 10min = 600000
    }
    /**
     * 登録データの取得
     */
    EntryData.prototype.getEntryData = function () {
        var _this = this;
        $.ajax({
            url: Cmn.dir + '/allData?offset=' + this.offset,
            dataType: 'json',
            type: 'GET',
            success: function (data) {
                switch (data.status) {
                    case 'success':
                        _this.setDataList(data.data);
                        _this.setTeam(data.data);
                        _this.offset = data.count;
                        break;
                }
                _this.flg.start = true;
            },
            error: function () {
            },
            complete: function () {
            }
        });
    };
    /**
     * チームデータの整形と出力
     * @param data
     */
    EntryData.prototype.setDataList = function (data) {
        var _this = this;
        var elem = '';
        $.get(this.listTemplate, function (template) {
            for (var i = (data.length - 1); i >= 0; i--) {
                var obj = data[i];
                obj.uploads = Cmn.dir + '/uploads';
                obj.time = _this.getTimeDiff(obj.created_at);
                if (_this.filtering === obj.team)
                    obj.hidden = ' hidden';
                elem += Mustache.render(template, obj);
            }
            $(_this.target.result).prepend(elem);
            _this.elem = $('.filterResult');
        });
    };
    /**
     * チーム選択リストの整形
     * @param data
     */
    EntryData.prototype.setTeam = function (data) {
        var _this = this;
        $.get(this.filterTemplate, function (template) {
            var elem = '';
            for (var i = 0, iLen = data.length; i < iLen; i++) {
                var obj = data[i], isArr = _this.team.indexOf(obj.team);
                if (isArr > -1)
                    continue;
                _this.team.push(obj.team);
                elem += Mustache.render(template, obj);
            }
            $(_this.target.select).append(elem);
        });
    };
    /**
     * 登録日付が今からどれくらい前か
     * @param times
     * @returns {string}
     */
    EntryData.prototype.getTimeDiff = function (times) {
        var now = new Date().getTime(), setTime = times.replace(/-/g, '/'), timestamp = new Date(setTime).getTime(), diffTime = now - timestamp, timeData = diffTime / 1000 >> 0; // 1000ミリ秒で割る
        if (timeData < 60) {
            return timeData + '秒前';
        }
        // 60秒で割る
        timeData = timeData / 60 >> 0;
        if (timeData < 60) {
            return timeData + '分前';
        }
        // 60分で割る
        timeData = timeData / 60 >> 0;
        if (timeData < 24) {
            return timeData + '時間前';
        }
        // 24時間で割る
        timeData = timeData / 24 >> 0;
        if (timeData < 365) {
            return timeData + '日前';
        }
        // 365日で割る
        timeData = timeData / 365 >> 0;
        return timeData + '年以上前';
    };
    return EntryData;
})();
new EntryData();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBsdWdpbnMvRW50cnlEYXRhLnRzIl0sIm5hbWVzIjpbIkVudHJ5RGF0YSIsIkVudHJ5RGF0YS5jb25zdHJ1Y3RvciIsIkVudHJ5RGF0YS5nZXRFbnRyeURhdGEiLCJFbnRyeURhdGEuc2V0RGF0YUxpc3QiLCJFbnRyeURhdGEuc2V0VGVhbSIsIkVudHJ5RGF0YS5nZXRUaW1lRGlmZiJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7O2dGQVFnRjtBQUNoRixrREFBa0Q7QUFDbEQsa0RBQWtEO0FBQ2xELHVDQUF1QztBQUN2QyxtREFBbUQ7QUFDbkQsMENBQTBDO0FBRTFDLElBQU0sU0FBUztJQW1CYkEsU0FuQklBLFNBQVNBO1FBRUxDLFNBQUlBLEdBQUdBLEVBQUVBLENBQUNBO1FBQ1ZBLGNBQVNBLEdBQVVBLEVBQUVBLENBQUNBO1FBRXRCQSxXQUFNQSxHQUFVQSxDQUFDQSxDQUFDQTtRQUVsQkEsaUJBQVlBLEdBQVVBLEdBQUdBLENBQUNBLEdBQUdBLEdBQUdBLDRCQUE0QkEsQ0FBQ0E7UUFDN0RBLG1CQUFjQSxHQUFVQSxHQUFHQSxDQUFDQSxHQUFHQSxHQUFHQSwwQkFBMEJBLENBQUNBO1FBRTdEQSxXQUFNQSxHQUFHQTtZQUNmQSxNQUFNQSxFQUFFQSxhQUFhQTtZQUNyQkEsTUFBTUEsRUFBRUEsbUJBQW1CQTtTQUM1QkEsQ0FBQ0E7UUFFTUEsUUFBR0EsR0FBR0E7WUFDWkEsS0FBS0EsRUFBRUEsS0FBS0E7U0FDYkEsQ0FBQ0E7UUFHQUEsSUFBSUEsRUFBRUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFFZEEsQUFDQUEsV0FEV0E7UUFDWEEsRUFBRUEsQ0FBQ0EsWUFBWUEsRUFBRUEsQ0FBQ0E7UUFFbEJBLEFBQ0FBLGdCQURnQkE7UUFDaEJBLFdBQVdBLENBQUNBO1lBQ1ZBLEVBQUVBLENBQUFBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBLEtBQUtBLEtBQUtBLEtBQUtBLENBQUNBO2dCQUFDQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQTtZQUV4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LEdBQUdBLFFBQVFBLEdBQUdBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQzlCQSxFQUFFQSxDQUFBQSxDQUFDQSxRQUFRQSxHQUFHQSxFQUFFQSxDQUFDQSxDQUFBQSxDQUFDQTtZQUNoQkEsTUFBTUEsQ0FBQ0EsUUFBUUEsR0FBR0EsS0FBS0EsQ0FBQ0E7UUFDMUJBLENBQUNBO1FBRURBLEFBQ0FBLFVBRFVBO1FBQ1ZBLFFBQVFBLEdBQUdBLFFBQVFBLEdBQUdBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQzlCQSxFQUFFQSxDQUFBQSxDQUFDQSxRQUFRQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFBQSxDQUFDQTtZQUNqQkEsTUFBTUEsQ0FBQ0EsUUFBUUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDekJBLENBQUNBO1FBRURBLEFBQ0FBLFVBRFVBO1FBQ1ZBLFFBQVFBLEdBQUdBLFFBQVFBLEdBQUdBLEdBQUdBLElBQUlBLENBQUNBLENBQUNBO1FBQy9CQSxNQUFNQSxDQUFDQSxRQUFRQSxHQUFHQSxNQUFNQSxDQUFDQTtJQUMzQkEsQ0FBQ0E7SUFDSEwsZ0JBQUNBO0FBQURBLENBdE1BLEFBc01DQSxJQUFBO0FBRUQsSUFBSSxTQUFTLEVBQUUsQ0FBQyIsImZpbGUiOiJwbHVnaW5zL0VudHJ5RGF0YS5qcyIsInNvdXJjZVJvb3QiOiIuLi9fd3MvdHlwZXNjcmlwdC8iLCJzb3VyY2VzQ29udGVudCI6WyIvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICogRW50cnkgRGF0YVxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxNS4gQ29kZSBmb3IgS09SSVlBTUEuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogQGF1dGhvcjogTm9idXl1a2kgS29uZG9cbiAqIEB1cmk6IGh0dHA6Ly9rb3JpeWFtYS5pby9cbiAqIEB2ZXJzaW9uOiAxLjBcbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG4vLy88cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9kdHMvbGlicy9qcXVlcnkuZC50c1wiIC8+XG4vLy88cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9kdHMvbGlicy9jdXN0b20uZC50c1wiIC8+XG4vLy88cmVmZXJlbmNlIHBhdGg9XCIuLi9hc3NldHMvQ21uLnRzXCIvPlxuLy8vPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vZHRzL2xpYnMvbXVzdGFjaGUuZC50c1wiLz5cbi8vLzxyZWZlcmVuY2UgcGF0aD1cIi4uL2Fzc2V0cy9FdmVudHMudHNcIi8+XG5cbmNsYXNzIEVudHJ5RGF0YSB7XG4gIHByaXZhdGUgZWxlbTphbnk7XG4gIHByaXZhdGUgdGVhbSA9IFtdO1xuICBwcml2YXRlIGZpbHRlcmluZzpzdHJpbmcgPSAnJztcblxuICBwcml2YXRlIG9mZnNldDpudW1iZXIgPSAwO1xuXG4gIHByaXZhdGUgbGlzdFRlbXBsYXRlOnN0cmluZyA9IENtbi5kaXIgKyAnL211cy9maWx0ZXJSZXN1bHQubXVzdGFjaGUnO1xuICBwcml2YXRlIGZpbHRlclRlbXBsYXRlOnN0cmluZyA9IENtbi5kaXIgKyAnL211cy9maWx0ZXJUZWFtLm11c3RhY2hlJztcblxuICBwcml2YXRlIHRhcmdldCA9IHtcbiAgICBzZWxlY3Q6ICcjdGVhbUZpbHRlcicsXG4gICAgcmVzdWx0OiAnI2xhbmRzY2FwZS1yZXN1bHQnXG4gIH07XG5cbiAgcHJpdmF0ZSBmbGcgPSB7XG4gICAgc3RhcnQ6IGZhbHNlXG4gIH07XG5cbiAgY29uc3RydWN0b3IoKXtcbiAgICB2YXIgX3QgPSB0aGlzO1xuXG4gICAgLy8g5Yid5pyf44OH44O844K/44Gu5Y+W5b6XXG4gICAgX3QuZ2V0RW50cnlEYXRhKCk7XG5cbiAgICAvLyDjg4fjg7zjgr/jga7mm7TmlrAoMTDnp5LjgZTjgagpXG4gICAgc2V0SW50ZXJ2YWwoKCk9PntcbiAgICAgIGlmKF90LmZsZy5zdGFydCA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTtcblxuICAgICAgX3QuZmxnLnN0YXJ0ID0gZmFsc2U7XG4gICAgICBfdC5nZXRFbnRyeURhdGEoKTtcbiAgICB9LCAxMDAwMCk7ICAgIC8vIDEwMDBtcyAqIDEwcyA9IDEwMDAwXG5cbiAgICAvLyDml6Xku5jjga7mm7TmlrAoMzDnp5Lmr44pXG4gICAgc2V0SW50ZXJ2YWwoKCk9PntcbiAgICAgIGlmKF90LmVsZW0gPT09IHZvaWQgMCB8fCBfdC5mbGcuc3RhcnQgPT09IGZhbHNlKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gX3QuZWxlbS5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHtcbiAgICAgICAgdmFyIG9iaiA9ICQoX3QuZWxlbVtpXSksXG4gICAgICAgICAgY3JlYXRlID0gb2JqLmRhdGEoJ2NyZWF0ZWQnKSxcbiAgICAgICAgICB0aW1lID0gX3QuZ2V0VGltZURpZmYoY3JlYXRlKTtcblxuICAgICAgICBvYmouZmluZCgnLmZpbHRlclJlc3VsdC1kYXRlJykudGV4dCh0aW1lKTtcbiAgICAgIH1cbiAgICB9LCAzMDAwMCk7ICAgLy8gMTAwMG1zICogMzBzID0gMzAwMDBcblxuICAgIC8vIOODgeODvOODoOODleOCo+ODq+OCv+ODquODs+OCsFxuICAgICQoZG9jdW1lbnQpLm9uKCdjaGFuZ2UnLCBfdC50YXJnZXQuc2VsZWN0LCBmdW5jdGlvbigpe1xuICAgICAgX3QuZWxlbS5yZW1vdmVDbGFzcygnaGlkZGVuJyk7XG5cbiAgICAgIHZhciBzZWxlY3RlZCA9ICQodGhpcykudmFsKCk7XG5cbiAgICAgIGlmKHNlbGVjdGVkID09PSAnMCcpe1xuICAgICAgICBfdC5maWx0ZXJpbmcgPSAnJztcbiAgICAgIH1lbHNle1xuICAgICAgICBfdC5maWx0ZXJpbmcgPSBzZWxlY3RlZDtcblxuICAgICAgICBfdC5lbGVtLmZpbHRlcihmdW5jdGlvbihpbmRleCl7XG4gICAgICAgICAgdmFyIHNlbGYgPSAkKHRoaXMpLFxuICAgICAgICAgICAgdGVhbSA9IHNlbGYuZGF0YSgndGVhbScpO1xuXG4gICAgICAgICAgaWYodGVhbSAhPT0gc2VsZWN0ZWQpIHNlbGYuYWRkQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIOWJiumZpOODh+ODvOOCv+OBjOacieOCi+WgtOWQiOOBr3JlbW92ZSgxMOWIhuavjilcbiAgICBzZXRJbnRlcnZhbCgoKT0+e1xuICAgICAgJC5hamF4KHtcbiAgICAgICAgdXJsOiBDbW4uZGlyICsgJy9kZWxldGVEYXRhJyxcbiAgICAgICAgZGF0YVR5cGU6ICdqc29uJyxcbiAgICAgICAgdHlwZTogJ0dFVCcsXG4gICAgICAgIHN1Y2Nlc3M6IChkYXRhKT0+e1xuICAgICAgICAgIGlmKGRhdGEuc3RhdHVzID09PSAnc3VjY2Vzcycpe1xuICAgICAgICAgICAgX3QuZWxlbS5maWx0ZXIoZnVuY3Rpb24oaW5kZXgpe1xuICAgICAgICAgICAgICB2YXIgc2VsZiA9ICQodGhpcyksXG4gICAgICAgICAgICAgICAgZGF0YV9pZCA9IFN0cmluZyhzZWxmLmRhdGEoJ2lkJykpLFxuICAgICAgICAgICAgICAgIGlzUmVtb3ZlID0gZGF0YS5saXN0LmluZGV4T2YoZGF0YV9pZCk7XG5cbiAgICAgICAgICAgICAgaWYoaXNSZW1vdmUgPiAtMSl7XG4gICAgICAgICAgICAgICAgLy8g5YmK6Zmk44OH44O844K/44GM5a2Y5Zyo44GZ44KL5aC05ZCIXG4gICAgICAgICAgICAgICAgc2VsZi5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICBfdC5lbGVtLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3I6ICgpPT57fSxcbiAgICAgICAgY29tcGxldGU6ICgpPT57fVxuICAgICAgfSk7XG4gICAgfSwgNjAwMDAwKTsgICAgLy8gMTAwMG1zICogNjBzICogMTBtaW4gPSA2MDAwMDBcbiAgfVxuXG5cbiAgLyoqXG4gICAqIOeZu+mMsuODh+ODvOOCv+OBruWPluW+l1xuICAgKi9cbiAgZ2V0RW50cnlEYXRhKCl7XG4gICAgJC5hamF4KHtcbiAgICAgIHVybDogQ21uLmRpciArICcvYWxsRGF0YT9vZmZzZXQ9JyArIHRoaXMub2Zmc2V0LFxuICAgICAgZGF0YVR5cGU6ICdqc29uJyxcbiAgICAgIHR5cGU6ICdHRVQnLFxuICAgICAgc3VjY2VzczogKGRhdGEpPT57XG4gICAgICAgIHN3aXRjaChkYXRhLnN0YXR1cyl7XG4gICAgICAgICAgY2FzZSAnc3VjY2Vzcyc6XG4gICAgICAgICAgICB0aGlzLnNldERhdGFMaXN0KGRhdGEuZGF0YSk7XG4gICAgICAgICAgICB0aGlzLnNldFRlYW0oZGF0YS5kYXRhKTtcbiAgICAgICAgICAgIHRoaXMub2Zmc2V0ID0gZGF0YS5jb3VudDtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZmxnLnN0YXJ0ID0gdHJ1ZTtcbiAgICAgIH0sXG4gICAgICBlcnJvcjogKCk9Pnt9LFxuICAgICAgY29tcGxldGU6ICgpPT57fVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOODgeODvOODoOODh+ODvOOCv+OBruaVtOW9ouOBqOWHuuWKm1xuICAgKiBAcGFyYW0gZGF0YVxuICAgKi9cbiAgc2V0RGF0YUxpc3QoZGF0YSl7XG4gICAgdmFyIGVsZW0gPSAnJztcblxuICAgICQuZ2V0KHRoaXMubGlzdFRlbXBsYXRlLCAodGVtcGxhdGUpPT57XG4gICAgICBmb3IgKHZhciBpID0gKGRhdGEubGVuZ3RoIC0gMSk7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgIHZhciBvYmogPSBkYXRhW2ldO1xuXG4gICAgICAgIG9iai51cGxvYWRzID0gQ21uLmRpciArICcvdXBsb2Fkcyc7XG4gICAgICAgIG9iai50aW1lID0gdGhpcy5nZXRUaW1lRGlmZihvYmouY3JlYXRlZF9hdCk7XG4gICAgICAgIGlmKHRoaXMuZmlsdGVyaW5nID09PSBvYmoudGVhbSkgb2JqLmhpZGRlbiA9ICcgaGlkZGVuJztcbiAgICAgICAgZWxlbSArPSBNdXN0YWNoZS5yZW5kZXIodGVtcGxhdGUsIG9iaik7XG4gICAgICB9XG5cbiAgICAgICQodGhpcy50YXJnZXQucmVzdWx0KS5wcmVwZW5kKGVsZW0pO1xuICAgICAgdGhpcy5lbGVtID0gJCgnLmZpbHRlclJlc3VsdCcpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOODgeODvOODoOmBuOaKnuODquOCueODiOOBruaVtOW9olxuICAgKiBAcGFyYW0gZGF0YVxuICAgKi9cbiAgc2V0VGVhbShkYXRhKXtcbiAgICAkLmdldCh0aGlzLmZpbHRlclRlbXBsYXRlLCAodGVtcGxhdGUpPT57XG4gICAgICB2YXIgZWxlbSA9ICcnO1xuICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBkYXRhLmxlbmd0aDsgaSA8IGlMZW47IGkrKykge1xuICAgICAgICB2YXIgb2JqID0gZGF0YVtpXSxcbiAgICAgICAgICBpc0FyciA9IHRoaXMudGVhbS5pbmRleE9mKG9iai50ZWFtKTtcblxuICAgICAgICBpZihpc0FyciA+IC0xKSBjb250aW51ZTtcblxuICAgICAgICB0aGlzLnRlYW0ucHVzaChvYmoudGVhbSk7XG4gICAgICAgIGVsZW0gKz0gTXVzdGFjaGUucmVuZGVyKHRlbXBsYXRlLCBvYmopO1xuICAgICAgfVxuXG4gICAgICAkKHRoaXMudGFyZ2V0LnNlbGVjdCkuYXBwZW5kKGVsZW0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOeZu+mMsuaXpeS7mOOBjOS7iuOBi+OCieOBqeOCjOOBj+OCieOBhOWJjeOBi1xuICAgKiBAcGFyYW0gdGltZXNcbiAgICogQHJldHVybnMge3N0cmluZ31cbiAgICovXG4gIGdldFRpbWVEaWZmKHRpbWVzKXtcbiAgICB2YXIgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCksXG4gICAgICBzZXRUaW1lID0gdGltZXMucmVwbGFjZSgvLS9nLCAnLycpLCAgIC8vIGlPU+WvvuW/nOOAguOBvuOBleOBi+ODj+OCpOODleODs+OCteODneODvOODiOOBl+OBpuOBquOBhOOBqOOBi+ODu+ODu+ODu1xuICAgICAgdGltZXN0YW1wID0gbmV3IERhdGUoc2V0VGltZSkuZ2V0VGltZSgpLFxuICAgICAgZGlmZlRpbWUgPSBub3cgLSB0aW1lc3RhbXAsXG4gICAgICB0aW1lRGF0YSA9IGRpZmZUaW1lIC8gMTAwMCA+PiAwOyAgIC8vIDEwMDDjg5/jg6rnp5LjgaflibLjgotcblxuICAgIGlmKHRpbWVEYXRhIDwgNjApe1xuICAgICAgcmV0dXJuIHRpbWVEYXRhICsgJ+enkuWJjSc7XG4gICAgfVxuXG4gICAgLy8gNjDnp5LjgaflibLjgotcbiAgICB0aW1lRGF0YSA9IHRpbWVEYXRhIC8gNjAgPj4gMDtcbiAgICBpZih0aW1lRGF0YSA8IDYwKXtcbiAgICAgIHJldHVybiB0aW1lRGF0YSArICfliIbliY0nO1xuICAgIH1cblxuICAgIC8vIDYw5YiG44Gn5Ymy44KLXG4gICAgdGltZURhdGEgPSB0aW1lRGF0YSAvIDYwID4+IDA7XG4gICAgaWYodGltZURhdGEgPCAyNCl7XG4gICAgICByZXR1cm4gdGltZURhdGEgKyAn5pmC6ZaT5YmNJztcbiAgICB9XG5cbiAgICAvLyAyNOaZgumWk+OBp+WJsuOCi1xuICAgIHRpbWVEYXRhID0gdGltZURhdGEgLyAyNCA+PiAwO1xuICAgIGlmKHRpbWVEYXRhIDwgMzY1KXtcbiAgICAgIHJldHVybiB0aW1lRGF0YSArICfml6XliY0nO1xuICAgIH1cblxuICAgIC8vIDM2NeaXpeOBp+WJsuOCi1xuICAgIHRpbWVEYXRhID0gdGltZURhdGEgLyAzNjUgPj4gMDtcbiAgICByZXR1cm4gdGltZURhdGEgKyAn5bm05Lul5LiK5YmNJztcbiAgfVxufVxuXG5uZXcgRW50cnlEYXRhKCk7XG4iXX0=